<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…±æ„Ÿå·¥ä½œå®¤ Pro - Spotify ç‰ˆæœ¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        #canvas-3d {
            display: block;
            width: 100%;
            height: 100%;
        }
        #canvas-2d {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
        }
        .control-group input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            background: #4B5563;
            border-radius: 4px;
        }
        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #1DB954;
            border-radius: 50%;
            cursor: pointer;
        }
        .preset-btn.active {
            background: #1DB954 !important;
            border-color: #1ed760 !important;
        }
        .style-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        .spotify-btn {
            background: linear-gradient(135deg, #1DB954, #1ed760);
        }
        .spotify-btn:hover {
            background: linear-gradient(135deg, #1ed760, #1DB954);
        }
        .search-result {
            background: rgba(31, 41, 55, 0.8);
            border: 1px solid rgba(29, 185, 84, 0.3);
            border-radius: 8px;
            padding: 10px;
            margin: 6px 0;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 12px;
        }
        .search-result:hover {
            border-color: rgba(29, 185, 84, 0.8);
            background: rgba(31, 41, 55, 1);
        }
        .now-playing {
            background: rgba(29, 185, 84, 0.1);
            border-left: 3px solid #1DB954;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            color: #e5e7eb;
        }
        .album-art {
            width: 50px;
            height: 50px;
            border-radius: 4px;
            margin-right: 10px;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen antialiased">

    <div id="app" class="flex h-screen overflow-hidden">

        <!-- å·¦å´æ§åˆ¶é¢æ¿ -->
        <div class="w-full lg:w-1/3 xl:w-1/4 p-6 flex flex-col space-y-4 bg-gray-800 border-r border-gray-700 overflow-y-auto">
            
            <header class="pb-4 border-b border-gray-700">
                <h1 class="text-2xl font-extrabold text-green-400">å…±æ„Ÿå·¥ä½œå®¤</h1>
                <p class="text-xs text-gray-400 mt-1">Spotify Ã— éŸ³æ¨‚ Ã— è¦–è¦ºåŒ–</p>
            </header>

            <!-- Spotify ç™»å…¥å€ -->
            <div class="space-y-2" id="spotify-section">
                <h2 class="text-lg font-semibold text-gray-200">ğŸµ Spotify</h2>
                <button id="spotify-login-btn" class="spotify-btn text-white font-bold py-2 px-4 rounded-lg text-sm w-full transition">
                    ğŸ¶ é€£æ¥ Spotify
                </button>
                <p id="spotify-user" class="text-xs text-gray-400 hidden">âœ… å·²é€£æ¥</p>
            </div>

            <!-- æœå°‹å€ -->
            <div class="space-y-2 pt-2 border-t border-gray-700" id="search-section" style="display: none;">
                <h2 class="text-lg font-semibold text-gray-200">ğŸ” æœå°‹æ­Œæ›²</h2>
                <div class="flex gap-2">
                    <input type="text" id="search-input" placeholder="æœå°‹æ­Œæ›²..." 
                           class="flex-1 px-3 py-2 bg-gray-700 text-white rounded-lg text-xs focus:outline-none focus:ring-2 focus:ring-green-400">
                    <button id="search-btn" class="spotify-btn text-white font-bold px-4 rounded-lg text-xs">
                        ğŸ”
                    </button>
                </div>
                <div id="search-results" class="max-h-40 overflow-y-auto"></div>
            </div>

            <!-- æ­£åœ¨æ’­æ”¾ -->
            <div class="space-y-2 pt-2 border-t border-gray-700" id="now-playing-section" style="display: none;">
                <h2 class="text-lg font-semibold text-gray-200">ğŸ§ æ­£åœ¨æ’­æ”¾</h2>
                <div id="now-playing" class="now-playing hidden">
                    <div class="flex items-center">
                        <img id="track-image" class="album-art">
                        <div class="flex-1">
                            <p id="track-name" class="font-semibold text-green-400">-</p>
                            <p id="track-artist" class="text-gray-400">-</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- åœ–ç‰‡ä¸Šå‚³å€ -->
            <div class="space-y-2 pt-2 border-t border-gray-700">
                <h2 class="text-lg font-semibold text-gray-200">ğŸ–¼ï¸ ä¸Šå‚³åœ–ç‰‡</h2>
                <input type="file" id="image-input" accept="image/*" class="hidden" onchange="handleImageSelect(event)">
                <label for="image-input" class="cursor-pointer block text-center spotify-btn text-white font-bold py-2 px-4 rounded-lg text-sm">
                    ğŸ¨ ä¸Šå‚³åœ–ç‰‡
                </label>
                <img id="preview-image" class="hidden rounded-lg max-h-24 mx-auto">
            </div>

            <!-- é è¨­é¢¨æ ¼ -->
            <div class="space-y-2 pt-2 border-t border-gray-700">
                <h2 class="text-lg font-semibold text-gray-200">âœ¨ è¦–è¦ºé¢¨æ ¼</h2>
                <div class="style-grid text-xs">
                    <button class="preset-btn active bg-green-600 p-2 rounded-lg font-medium border-2 border-green-400" data-preset="neon">éœ“è™¹æ•…éšœ</button>
                    <button class="preset-btn bg-gray-700 p-2 rounded-lg font-medium border-2 border-transparent" data-preset="liquid">æµå‹•æ¶²æ…‹</button>
                    <button class="preset-btn bg-gray-700 p-2 rounded-lg font-medium border-2 border-transparent" data-preset="geometric">å¹¾ä½•æ³¢ç´‹</button>
                    <button class="preset-btn bg-gray-700 p-2 rounded-lg font-medium border-2 border-transparent" data-preset="particle">èƒ½é‡ç²’å­</button>
                    <button class="preset-btn bg-gray-700 p-2 rounded-lg font-medium border-2 border-transparent" data-preset="spectrum">é »è­œæŸ±ç‹€</button>
                    <button class="preset-btn bg-gray-700 p-2 rounded-lg font-medium border-2 border-transparent" data-preset="ripple">æ¼£æ¼ªæ³¢å‹•</button>
                    <button class="preset-btn bg-gray-700 p-2 rounded-lg font-medium border-2 border-transparent" data-preset="spiral">æ—‹è½‰èºæ—‹</button>
                    <button class="preset-btn bg-gray-700 p-2 rounded-lg font-medium border-2 border-transparent" data-preset="trail">å…‰è»Œè·¡</button>
                    <button class="preset-btn bg-gray-700 p-2 rounded-lg font-medium border-2 border-transparent" data-preset="mandelbrot">åˆ†å½¢è—è¡“</button>
                    <button class="preset-btn bg-gray-700 p-2 rounded-lg font-medium border-2 border-transparent" data-preset="plasma">é›»æ¼¿æ•ˆæ‡‰</button>
                    <button class="preset-btn bg-gray-700 p-2 rounded-lg font-medium border-2 border-transparent" data-preset="tunnel">æ˜Ÿå…‰éš§é“</button>
                    <button class="preset-btn bg-gray-700 p-2 rounded-lg font-medium border-2 border-transparent" data-preset="imagewave">åœ–ç‰‡æ³¢å‹•</button>
                </div>
            </div>

            <!-- åƒæ•¸æ§åˆ¶ -->
            <div class="space-y-2 pt-2 border-t border-gray-700">
                <h2 class="text-lg font-semibold text-gray-200">âš™ï¸ åƒæ•¸</h2>
                
                <div class="control-group">
                    <label class="block text-xs font-medium text-gray-300">ç¯€æ‹</label>
                    <input type="range" min="1" max="100" value="75" id="range-beat">
                </div>

                <div class="control-group">
                    <label class="block text-xs font-medium text-gray-300">é¡è‰²</label>
                    <input type="range" min="1" max="100" value="45" id="range-frequency">
                </div>
                
                <div class="control-group">
                    <label class="block text-xs font-medium text-gray-300">å¯†åº¦</label>
                    <input type="range" min="1" max="100" value="90" id="range-intensity">
                </div>
                
                <div class="control-group">
                    <label class="block text-xs font-medium text-gray-300">é€Ÿåº¦</label>
                    <input type="range" min="1" max="100" value="60" id="range-speed">
                </div>
            </div>

            <!-- æ’­æ”¾æ§åˆ¶ -->
            <div class="pt-2 border-t border-gray-700" id="playback-section" style="display: none;">
                <div class="flex gap-2">
                    <button id="prev-btn" class="flex-1 spotify-btn text-white font-bold py-2 rounded-lg text-sm">â®ï¸</button>
                    <button id="play-btn" class="flex-1 spotify-btn text-white font-bold py-2 rounded-lg text-sm">â–¶ï¸</button>
                    <button id="next-btn" class="flex-1 spotify-btn text-white font-bold py-2 rounded-lg text-sm">â­ï¸</button>
                </div>
            </div>
        </div>

        <!-- å³å´è¦–è¦ºè¼¸å‡º -->
        <div class="flex-1 relative bg-black overflow-hidden">
            <h2 class="absolute top-4 left-4 z-10 text-lg font-bold text-white bg-black bg-opacity-50 px-3 py-1 rounded">
                ğŸ¨ è¦–è¦ºè¼¸å‡º
            </h2>
            <canvas id="canvas-3d"></canvas>
            <canvas id="canvas-2d"></canvas>
        </div>
    </div>

    <script>
        // â•â•â• Spotify é…ç½® â•â•â•
        const CLIENT_ID = 'cd24ef8a4eeb4d7895464f0e0d7f5c05';
        const REDIRECT_URI = window.location.origin + window.location.pathname;
        const SCOPES = [
            'streaming',
            'user-read-private',
            'user-read-email',
            'user-read-playback-state',
            'user-modify-playback-state',
            'user-read-currently-playing'
        ];

        // â•â•â• å…¨åŸŸè®Šæ•¸ â•â•â•
        const canvas3D = document.getElementById('canvas-3d');
        const canvas2D = document.getElementById('canvas-2d');
        const ctx2D = canvas2D.getContext('2d');
        
        let scene, camera, renderer;
        let audioContext, analyser, dataArray;
        let currentPreset = 'neon';
        let uploadedImage = null;
        let spotifyToken = null;
        let spotifyPlayer = null;
        let currentDevice = null;

        // Spotify ç›¸é—œ DOM
        const loginBtn = document.getElementById('spotify-login-btn');
        const searchSection = document.getElementById('search-section');
        const nowPlayingSection = document.getElementById('now-playing-section');
        const playbackSection = document.getElementById('playback-section');
        const spotifyUserDisplay = document.getElementById('spotify-user');

        // â•â•â• åˆå§‹åŒ– â•â•â•
        window.addEventListener('load', () => {
            initThree();
            setupNeon();
            updateSceneWithImage();
            animate();

            // æª¢æŸ¥ URL ä¸­æ˜¯å¦æœ‰ token
            const hash = window.location.hash;
            if (hash) {
                const token = new URLSearchParams(hash.substring(1)).get('access_token');
                if (token) {
                    spotifyToken = token;
                    localStorage.setItem('spotify_token', token);
                    window.location.hash = '';
                    initSpotify();
                }
            } else {
                spotifyToken = localStorage.getItem('spotify_token');
                if (spotifyToken) {
                    initSpotify();
                }
            }

            // ç™»å…¥æŒ‰éˆ•
            loginBtn.addEventListener('click', redirectToSpotifyAuth);
        });

        // â•â•â• Spotify èªè­‰ â•â•â•
        function redirectToSpotifyAuth() {
            const authUrl = new URL('https://accounts.spotify.com/authorize');
            authUrl.searchParams.append('client_id', CLIENT_ID);
            authUrl.searchParams.append('response_type', 'token');
            authUrl.searchParams.append('redirect_uri', REDIRECT_URI);
            authUrl.searchParams.append('scope', SCOPES.join(' '));
            window.location.href = authUrl.toString();
        }

        // â•â•â• åˆå§‹åŒ– Spotify â•â•â•
        function initSpotify() {
            loginBtn.textContent = 'âœ… å·²é€£æ¥ Spotify';
            loginBtn.disabled = true;
            spotifyUserDisplay.classList.remove('hidden');
            searchSection.style.display = 'block';
            nowPlayingSection.style.display = 'block';
            playbackSection.style.display = 'block';

            // åˆå§‹åŒ– Web Playback SDK
            window.onSpotifyWebPlaybackSDKReady = () => {
                spotifyPlayer = new Spotify.Player({
                    name: 'å…±æ„Ÿå·¥ä½œå®¤',
                    getOAuthToken: cb => { cb(spotifyToken); },
                    volume: 0.5
                });

                spotifyPlayer.addListener('player_state_changed', state => {
                    if (state) {
                        const current = state.track_window.current_track;
                        updateNowPlaying(current);
                    }
                });

                spotifyPlayer.connect().then(success => {
                    if (success) {
                        console.log('Spotify Player å·²é€£æ¥');
                    }
                });
            };

            // æœå°‹åŠŸèƒ½
            document.getElementById('search-btn').addEventListener('click', searchTracks);
            document.getElementById('search-input').addEventListener('keypress', e => {
                if (e.key === 'Enter') searchTracks();
            });

            // æ’­æ”¾æ§åˆ¶
            document.getElementById('play-btn').addEventListener('click', togglePlay);
            document.getElementById('next-btn').addEventListener('click', nextTrack);
            document.getElementById('prev-btn').addEventListener('click', prevTrack);
        }

        // â•â•â• æœå°‹æ­Œæ›² â•â•â•
        async function searchTracks() {
            const query = document.getElementById('search-input').value;
            if (!query) return;

            try {
                const response = await fetch(
                    `https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&limit=8`,
                    {
                        headers: {
                            'Authorization': `Bearer ${spotifyToken}`
                        }
                    }
                );

                const data = await response.json();
                displaySearchResults(data.tracks.items);
            } catch (error) {
                console.error('æœå°‹å¤±æ•—:', error);
            }
        }

        // â•â•â• é¡¯ç¤ºæœå°‹çµæœ â•â•â•
        function displaySearchResults(tracks) {
            const resultsDiv = document.getElementById('search-results');
            resultsDiv.innerHTML = '';

            tracks.forEach(track => {
                const div = document.createElement('div');
                div.className = 'search-result';
                div.innerHTML = `
                    <p class="font-semibold text-green-400">${track.name}</p>
                    <p class="text-gray-400">${track.artists[0].name}</p>
                `;
                div.addEventListener('click', () => playTrack(track.uri));
                resultsDiv.appendChild(div);
            });
        }

        // â•â•â• æ’­æ”¾æ­Œæ›² â•â•â•
        async function playTrack(uri) {
            if (!spotifyPlayer) return;

            try {
                await fetch(`https://api.spotify.com/v1/me/player/play`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${spotifyToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ uris: [uri] })
                });

                // æ›´æ–°æ­£åœ¨æ’­æ”¾
                const trackId = uri.split(':')[2];
                const response = await fetch(
                    `https://api.spotify.com/v1/tracks/${trackId}`,
                    {
                        headers: {
                            'Authorization': `Bearer ${spotifyToken}`
                        }
                    }
                );
                const track = await response.json();
                updateNowPlaying(track);
            } catch (error) {
                console.error('æ’­æ”¾å¤±æ•—:', error);
            }
        }

        // â•â•â• æ›´æ–°æ­£åœ¨æ’­æ”¾ â•â•â•
        function updateNowPlaying(track) {
            if (!track) return;

            const nowPlayingDiv = document.getElementById('now-playing');
            const trackName = document.getElementById('track-name');
            const trackArtist = document.getElementById('track-artist');
            const trackImage = document.getElementById('track-image');

            trackName.textContent = track.name;
            trackArtist.textContent = track.artists?.[0]?.name || '-';

            if (track.album?.images?.[0]) {
                trackImage.src = track.album.images[0].url;
            }

            nowPlayingDiv.classList.remove('hidden');
        }

        // â•â•â• æ’­æ”¾æ§åˆ¶ â•â•â•
        function togglePlay() {
            if (spotifyPlayer) {
                spotifyPlayer.togglePlay();
            }
        }

        function nextTrack() {
            if (spotifyPlayer) {
                spotifyPlayer.nextTrack();
            }
        }

        function prevTrack() {
            if (spotifyPlayer) {
                spotifyPlayer.previousTrack();
            }
        }

        // â•â•â• åœ–ç‰‡ä¸Šå‚³ â•â•â•
        function handleImageSelect(e) {
            const files = e.target.files;
            if (files.length > 0) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        uploadedImage = img;
                        document.getElementById('preview-image').src = img.src;
                        document.getElementById('preview-image').classList.remove('hidden');
                        updateSceneWithImage();
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(files[0]);
            }
        }

        function updateSceneWithImage() {
            if (!uploadedImage) return;
            
            const canvas = document.createElement('canvas');
            canvas.width = canvas3D.clientWidth;
            canvas.height = canvas3D.clientHeight;
            const ctx = canvas.getContext('2d');
            
            const imgAspect = uploadedImage.width / uploadedImage.height;
            const canvasAspect = canvas.width / canvas.height;
            
            let drawWidth, drawHeight, drawX, drawY;
            
            if (imgAspect > canvasAspect) {
                drawHeight = canvas.height;
                drawWidth = drawHeight * imgAspect;
                drawX = (canvas.width - drawWidth) / 2;
                drawY = 0;
            } else {
                drawWidth = canvas.width;
                drawHeight = drawWidth / imgAspect;
                drawX = 0;
                drawY = (canvas.height - drawHeight) / 2;
            }
            
            ctx.globalAlpha = 0.3;
            ctx.drawImage(uploadedImage, drawX, drawY, drawWidth, drawHeight);
            
            const texture = new THREE.CanvasTexture(canvas);
            scene.background = texture;
        }

        // â•â•â• Three.js åˆå§‹åŒ– â•â•â•
        function initThree() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0a0a);

            camera = new THREE.PerspectiveCamera(75, canvas3D.clientWidth / canvas3D.clientHeight, 0.1, 1000);
            camera.position.z = 2;

            renderer = new THREE.WebGLRenderer({ canvas: canvas3D, antialias: true, alpha: true });
            renderer.setSize(canvas3D.clientWidth, canvas3D.clientHeight);

            const ambientLight = new THREE.AmbientLight(0xffffff, 1.5);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.5);
            directionalLight.position.set(5, 5, 5);
            scene.add(directionalLight);

            const pointLight = new THREE.PointLight(0x1DB954, 1.5, 100);
            pointLight.position.set(0, 0, 3);
            scene.add(pointLight);

            window.addEventListener('resize', () => {
                const w = canvas3D.clientWidth;
                const h = canvas3D.clientHeight;
                camera.aspect = w / h;
                camera.updateProjectionMatrix();
                renderer.setSize(w, h);
                canvas2D.width = w;
                canvas2D.height = h;
            });

            canvas2D.width = canvas3D.clientWidth;
            canvas2D.height = canvas3D.clientHeight;

            // é¢¨æ ¼åˆ‡æ›
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.addEventListener('click', (e) => switchPreset(e.target.dataset.preset));
            });
        }

        function switchPreset(preset) {
            currentPreset = preset;
            document.querySelectorAll('.preset-btn').forEach(b => {
                b.classList.remove('active', 'bg-green-600', 'border-green-400');
                b.classList.add('bg-gray-700', 'border-transparent');
            });
            event.target.classList.add('active', 'bg-green-600', 'border-green-400');
            
            const is3D = !['mandelbrot', 'plasma', 'imagewave'].includes(preset);
            canvas3D.style.display = is3D ? 'block' : 'none';
            canvas2D.style.display = is3D ? 'none' : 'block';
        }

        // â•â•â• ç°¡åŒ–ç‰ˆè¦–è¦ºåŒ–ï¼ˆæ ¸å¿ƒé¢¨æ ¼åªä¿ç•™é—œéµå‡½æ•¸ï¼‰ â•â•â•
        function setupNeon() {
            scene.clear();
            for (let i = 0; i < 8; i++) {
                const points = [];
                for (let x = -1; x <= 1; x += 0.05) {
                    points.push(new THREE.Vector3(x, Math.random() * 0.5, 0));
                }
                const geo = new THREE.BufferGeometry().setFromPoints(points);
                const mat = new THREE.LineBasicMaterial({ color: 0x1DB954 });
                const line = new THREE.Line(geo, mat);
                line.position.y = -1 + i * 0.3;
                scene.add(line);
            }
        }

        function updateNeon(audioData) {
            scene.children.forEach((line, i) => {
                const hue = (audioData.high + i * 0.1 + Date.now() / 10000) % 1;
                line.material.color.setHSL(hue, 1, 0.5);
            });
        }

        function getAudioData() {
            // æ¨¡æ“¬éŸ³è¨Šæ•¸æ“šï¼ˆå¯¦éš›æ‡‰ä½¿ç”¨ Spotify çš„ audio featuresï¼‰
            return {
                beat: Math.random() * 0.5,
                mid: Math.random() * 0.5,
                high: Math.random() * 0.5,
                intensity: Math.random() * 0.5,
                data: new Uint8Array(128).fill(128)
            };
        }

        // â•â•â• å‹•ç•«å¾ªç’° â•â•â•
        function animate() {
            requestAnimationFrame(animate);

            const audioData = getAudioData();

            if (currentPreset === 'neon') {
                updateNeon(audioData);
            }

            renderer.render(scene, camera);
        }

        // â•â•â• HSL è½‰ RGB â•â•â•
        function hslToRgb(h, s, l) {
            let r, g, b;
            if (s === 0) {
                r = g = b = l;
            } else {
                const hue2rgb = (p, q, t) => {
                    if (t < 0) t += 1;
                    if (t > 1) t -= 1;
                    if (t < 1/6) return p + (q - p) * 6 * t;
                    if (t < 1/2) return q;
                    if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                    return p;
                };
                const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                const p = 2 * l - q;
                r = hue2rgb(p, q, h + 1/3);
                g = hue2rgb(p, q, h);
                b = hue2rgb(p, q, h - 1/3);
            }
            return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];
        }
    </script>
</body>
</html>
