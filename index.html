<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…±æ„Ÿå·¥ä½œå®¤ - éŸ³æ¨‚è¦–è¦ºåŒ–ç”Ÿæˆå™¨</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Three.js (ç”¨æ–¼ 3D è¦–è¦ºåŒ–) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        /* ä½¿ç”¨ Inter å­—é«” */
        body { font-family: 'Inter', sans-serif; }
        /* ç¢ºä¿ Canvas å¡«æ»¿å®¹å™¨ */
        #visualization-canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        .control-group input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            background: #4B5563; /* Gray-600 */
            border-radius: 4px;
        }
        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #6366F1; /* Indigo-500 */
            border-radius: 50%;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen antialiased">

    <div id="app" class="flex h-screen overflow-hidden">

        <!-- å·¦å´æ§åˆ¶é¢æ¿ (Control Panel) -->
        <div class="w-full lg:w-1/3 xl:w-1/4 p-6 flex flex-col space-y-6 bg-gray-800 border-r border-gray-700 overflow-y-auto">
            
            <!-- æ¨™é¡Œèˆ‡æ¨™èª -->
            <header class="pb-4 border-b border-gray-700">
                <h1 class="text-3xl font-extrabold text-indigo-400">å…±æ„Ÿå·¥ä½œå®¤</h1>
                <p class="text-sm text-gray-400 mt-1">
                    å°‡éŸ³æ¨‚è½‰åŒ–ç‚ºç”Ÿæˆè—è¡“
                </p>
            </header>

            <!-- 1. éŸ³æ¨‚è¼¸å…¥å€ (Music Input) -->
            <div class="space-y-4">
                <h2 class="text-xl font-semibold text-gray-200">ğŸµ è¼¸å…¥éŸ³æ¨‚</h2>
                <div class="flex flex-col space-y-3">
                    <!-- æª”æ¡ˆè¼¸å…¥æœƒè§¸ç™¼ JavaScript ä¸­çš„ handleFileSelect å‡½æ•¸ -->
                    <input type="file" id="music-input" accept="audio/*" class="hidden" onchange="handleFileSelect(this.files)">
                    <label for="music-input" class="cursor-pointer bg-indigo-600 hover:bg-indigo-700 transition duration-150 text-white font-bold py-2 px-4 rounded-lg shadow-md flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                        ä¸Šå‚³æˆ–é¸æ“‡æ­Œæ›² (.mp3 / .wav)
                    </label>
                    <p id="file-name" class="text-sm text-gray-400 italic">æœªé¸æ“‡æª”æ¡ˆ</p>
                    <audio id="audio-player" class="hidden" controls></audio>
                </div>
            </div>

            <!-- 2. é è¨­é¢¨æ ¼ (Style Presets) -->
            <div class="space-y-4 pt-4 border-t border-gray-700">
                <h2 class="text-xl font-semibold text-gray-200">âœ¨ é¸æ“‡é è¨­é¢¨æ ¼</h2>
                <div class="grid grid-cols-2 gap-3">
                    <button class="preset-btn bg-gray-700 hover:bg-gray-600 p-3 rounded-lg text-sm font-medium transition duration-150 border-2 border-transparent focus:border-indigo-400" data-preset="neon">éœ“è™¹æ•…éšœé¢¨ (Neon Glitch)</button>
                    <button class="preset-btn bg-gray-700 hover:bg-gray-600 p-3 rounded-lg text-sm font-medium transition duration-150 border-2 border-transparent focus:border-indigo-400" data-preset="liquid">æµå‹•æ¶²æ…‹ (Liquid Flow)</button>
                    <button class="preset-btn bg-gray-700 hover:bg-gray-600 p-3 rounded-lg text-sm font-medium transition duration-150 border-2 border-transparent focus:border-indigo-400" data-preset="geometric">å¹¾ä½•æ³¢ç´‹ (Geometric Wave)</button>
                    <button class="preset-btn bg-gray-700 hover:bg-gray-600 p-3 rounded-lg text-sm font-medium transition duration-150 border-2 border-transparent focus:border-indigo-400" data-preset="particle">èƒ½é‡ç²’å­ (Energy Particle)</button>
                </div>
            </div>

            <!-- 3. åƒæ•¸å°æ‡‰è¨­å®š (Mapping Parameters) -->
            <div class="space-y-4 pt-4 border-t border-gray-700">
                <h2 class="text-xl font-semibold text-gray-200">âš™ï¸ åƒæ•¸å°æ‡‰è¨­å®š (å³æ™‚èª¿æ•´)</h2>
                
                <!-- ç¯€æ‹/éŸ»å¾‹å°æ‡‰ -->
                <div class="control-group">
                    <label class="block text-sm font-medium text-gray-300">ç¯€æ‹/éŸ»å¾‹ (Beat/Rhythm) â†’ å½¢ç‹€å°ºå¯¸ (Size)</label>
                    <input type="range" min="1" max="100" value="75" id="range-beat" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg transition duration-150">
                </div>

                <!-- é »ç‡/éŸ³é«˜å°æ‡‰ -->
                <div class="control-group">
                    <label class="block text-sm font-medium text-gray-300">é »ç‡/éŸ³é«˜ (Frequency/Note) â†’ é¡è‰²è®ŠåŒ– (Color Shift)</label>
                    <input type="range" min="1" max="100" value="45" id="range-frequency" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg transition duration-150">
                </div>
                
                <!-- å¼·åº¦/éŸ³é‡å°æ‡‰ -->
                <div class="control-group">
                    <label class="block text-sm font-medium text-gray-300">å¼·åº¦/éŸ³é‡ (Intensity/Volume) â†’ ç²’å­å¯†åº¦ (Density)</label>
                    <input type="range" min="1" max="100" value="90" id="range-intensity" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg transition duration-150">
                </div>
                
                <!-- å‹•ç•«é€Ÿåº¦ -->
                <div class="control-group">
                    <label class="block text-sm font-medium text-gray-300">å‹•ç•«é€Ÿåº¦ (Animation Speed)</label>
                    <input type="range" min="1" max="100" value="60" id="range-speed" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg transition duration-150">
                </div>

            </div>

            <!-- å‹•ä½œæŒ‰éˆ• -->
            <div class="pt-6 border-t border-gray-700">
                <!-- å•Ÿå‹•æŒ‰éˆ•ç¾åœ¨æœƒè§¸ç™¼æ’­æ”¾/æš«åœé‚è¼¯ -->
                <button id="start-btn" onclick="togglePlayback()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg text-lg shadow-xl transition duration-150 ease-in-out transform hover:scale-[1.02] active:scale-[0.98]">
                    â–¶ï¸ é–‹å§‹ç”Ÿæˆ (NFT / æ¼”å”±æœƒæ¨¡å¼)
                </button>
            </div>
            
        </div>

        <!-- å³å´è¦–è¦ºè¼¸å‡ºå€ (Visualization Output) -->
        <div class="flex-1 relative bg-black">
            <h2 class="absolute top-4 left-4 z-10 text-xl font-bold text-white bg-black bg-opacity-50 px-3 py-1 rounded-lg">
                å³æ™‚è¦–è¦ºè¼¸å‡ºå€
            </h2>
            <canvas id="visualization-canvas"></canvas>
            
            <!-- æ’­æ”¾æ§åˆ¶æ¨¡æ“¬ (ç¾å·²é€£æ¥åˆ°çœŸå¯¦çš„ audio-player ç‹€æ…‹) -->
            <div class="absolute bottom-0 w-full p-4 bg-gray-900 bg-opacity-70 flex justify-center items-center space-x-4">
                <button class="p-3 bg-gray-700 hover:bg-gray-600 rounded-full transition duration-150" onclick="document.getElementById('audio-player').currentTime -= 5">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                </button>
                <button id="play-pause-btn-bottom" class="p-4 bg-indigo-600 hover:bg-indigo-500 rounded-full transition duration-150" onclick="togglePlayback()">
                    <svg class="w-8 h-8 text-white" id="play-pause-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </button>
                <button class="p-3 bg-gray-700 hover:bg-gray-600 rounded-full transition duration-150" onclick="document.getElementById('audio-player').currentTime += 5">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                </button>
            </div>
        </div>

    </div>

    <script type="module">
        // --- å…¨åŸŸè®Šæ•¸ ---
        const canvas = document.getElementById('visualization-canvas');
        const audioPlayer = document.getElementById('audio-player');
        const fileNameDisplay = document.getElementById('file-name');
        const startBtn = document.getElementById('start-btn');
        const playPauseIcon = document.getElementById('play-pause-icon');
        
        // Three.js è®Šæ•¸
        let scene, camera, renderer;
        let cubes = [];
        const numCubes = 25; 
        
        // Web Audio API è®Šæ•¸
        let audioContext;
        let analyser;
        let dataArray;
        let isPlaying = false;

        // --- æ ¸å¿ƒéŸ³è¨Šè™•ç†é‚è¼¯ (Web Audio API) ---

        /**
         * åˆå§‹åŒ– Audio Context ä¸¦é€£æ¥ AnalyserNode
         */
        function setupAudioAnalysis() {
            if (!audioContext) {
                // é¦–æ¬¡äº’å‹•æ™‚å‰µå»º AudioContext (è§£æ±ºç€è¦½å™¨è‡ªå‹•æ’­æ”¾é™åˆ¶)
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // å‰µå»º AnalyserNode
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256; // é »è­œåˆ†æçš„å°ºå¯¸
                const bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);
                
                // å‰µå»º MediaElementSource
                const source = audioContext.createMediaElementSource(audioPlayer);
                
                // é€£æ¥ç¯€é»: ä¾†æº -> åˆ†æå™¨ -> è¼¸å‡º
                source.connect(analyser);
                analyser.connect(audioContext.destination);
            }
        }

        /**
         * è™•ç†æª”æ¡ˆé¸æ“‡äº‹ä»¶
         * @param {FileList} files - é¸æ“‡çš„æª”æ¡ˆåˆ—è¡¨
         */
        window.handleFileSelect = function(files) {
            if (files.length > 0) {
                const file = files[0];
                
                // --- åµéŒ¯æ—¥èªŒï¼šç¢ºèªæª”æ¡ˆæ˜¯å¦è¢«æ­£ç¢ºé¸å– ---
                console.log("æª”æ¡ˆå·²é¸å–:", file.name, "å¤§å°:", file.size, "MIMEé¡å‹:", file.type);
                // ----------------------------------------
                
                fileNameDisplay.textContent = file.name;

                // è¨­ç½® audio å…ƒç´ çš„æºç‚ºä¸Šå‚³çš„æª”æ¡ˆ
                audioPlayer.src = URL.createObjectURL(file);
                
                // é å…ˆè¨­å®šå¥½ Analyser
                setupAudioAnalysis(); 
                
                // é‡è¨­æ’­æ”¾ç‹€æ…‹
                isPlaying = false;
                updateButtonState();
            } else {
                fileNameDisplay.textContent = 'æœªé¸æ“‡æª”æ¡ˆ';
                audioPlayer.src = '';
            }
        };

        /**
         * æ’­æ”¾/æš«åœéŸ³æ¨‚ï¼Œä¸¦å•Ÿå‹•/åœæ­¢è¦–è¦ºåŒ–
         */
        window.togglePlayback = function() {
            if (!audioPlayer.src) {
                console.error("è«‹å…ˆä¸Šå‚³éŸ³æ¨‚æª”æ¡ˆã€‚");
                // é€™è£¡å¯ä»¥ä½¿ç”¨è‡ªå®šç¾© Modal é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                startBtn.textContent = "âŒ è«‹å…ˆä¸Šå‚³æª”æ¡ˆ";
                setTimeout(() => updateButtonState(), 1500);
                return;
            }

            if (isPlaying) {
                audioPlayer.pause();
                isPlaying = false;
            } else {
                // ç¢ºä¿ AudioContext ç‹€æ…‹æ˜¯ running
                if (audioContext && audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                audioPlayer.play().catch(e => console.error("æ’­æ”¾å¤±æ•—:", e));
                isPlaying = true;
            }

            updateButtonState();
        };

        /**
         * æ›´æ–°æŒ‰éˆ•çš„æ–‡å­—å’Œåœ–ç¤ºç‹€æ…‹
         */
        function updateButtonState() {
            if (isPlaying) {
                startBtn.innerHTML = 'â¸ï¸ æš«åœç”Ÿæˆ (é»æ“Šåœæ­¢)';
                startBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                startBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                // åº•éƒ¨æŒ‰éˆ•åœ–ç¤ºåˆ‡æ›ç‚ºæš«åœ
                playPauseIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>`; 
            } else {
                startBtn.innerHTML = 'â–¶ï¸ é–‹å§‹ç”Ÿæˆ (NFT / æ¼”å”±æœƒæ¨¡å¼)';
                startBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                startBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                // åº•éƒ¨æŒ‰éˆ•åœ–ç¤ºåˆ‡æ›ç‚ºæ’­æ”¾
                playPauseIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>`;
            }
        }

        // --- Three.js è¦–è¦ºåŒ–é‚è¼¯ ---

        /**
         * Initialize the Three.js scene, camera, and renderer.
         */
        function init() {
            scene = new THREE.Scene();
            // èƒŒæ™¯è‰²æ”¹ç‚ºæ·±è—ç°
            scene.background = new THREE.Color(0x111827); 

            // Camera setup
            camera = new THREE.PerspectiveCamera(75, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
            // æ‹‰è¿‘æ”å½±æ©Ÿ
            camera.position.z = 5; 

            // Renderer setup
            renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
            resizeRenderer();

            // Add lighting - å¢å¼·å…‰ç·šç¢ºä¿ç‰©ä»¶å¯è¦‹
            const ambientLight = new THREE.AmbientLight(0xffffff, 1.5); 
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 3);
            directionalLight.position.set(5, 5, 5).normalize();
            scene.add(directionalLight);

            // Add AxesHelper for debug confirmation - åŠ å…¥åº§æ¨™è»¸è¼”åŠ©å·¥å…·
            // ç´…è‰² = X, ç¶ è‰² = Y, è—è‰² = Z
            const axesHelper = new THREE.AxesHelper( 5 ); 
            scene.add( axesHelper );

            // Create cubes
            const cubeGeometry = new THREE.BoxGeometry(0.5, 0.5, 0.5);
            
            // ä¿®æ­£æè³ªç‚º MeshStandardMaterial (æ›´çœŸå¯¦çš„è‘—è‰²)
            const baseMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x6366F1, // Indigo 500
                emissive: 0x1E40AF, // Blue 800 - çµ¦äºˆè¼•å¾®çš„è‡ªç™¼å…‰æ•ˆæœ
                metalness: 0.2, 
                roughness: 0.5 
            }); 
            
            // å°‡æ–¹å¡Šæ’åˆ—æˆ 5x5 ç¶²æ ¼
            const cols = 5;
            const rows = 5;
            const spacing = 1.2;

            for (let i = 0; i < numCubes; i++) {
                const cube = new THREE.Mesh(cubeGeometry, baseMaterial.clone());
                
                const row = Math.floor(i / cols);
                const col = i % cols;

                // è¨ˆç®—ç¶²æ ¼ä¸­å¿ƒä½ç½®
                cube.position.x = (col - (cols - 1) / 2) * spacing;
                cube.position.y = (row - (rows - 1) / 2) * spacing;
                cube.position.z = 0; // æ”¾ç½®åœ¨æ”å½±æ©Ÿå‰æ–¹ 

                cube.initialY = cube.position.y; // Store initial Y for beat pulsing
                cubes.push(cube);
                scene.add(cube);
            }
        }
        
        /**
         * ç²å–çœŸå¯¦çš„éŸ³è¨Šåˆ†ææ•¸æ“š
         */
        function getRealAudioAnalysis() {
            if (!analyser || !isPlaying) {
                // å¦‚æœæ²’æœ‰æ’­æ”¾æˆ–åˆ†æå™¨æœªè¨­å®šï¼Œå‰‡è¿”å›é›¶æ•¸æ“š
                return { beat: 0, frequency: 0, intensity: 0, speed: 1.0 };
            }

            // å°‡é »ç‡æ•¸æ“šè¤‡è£½åˆ° dataArray
            analyser.getByteFrequencyData(dataArray);

            let sumIntensity = 0;
            let lowFreqSum = 0; // ä½é » (ç´„ç¯€æ‹/ä½éŸ³)
            let midFreqSum = 0; // ä¸­é » (ç´„äººè²/æ¨‚å™¨)
            const lowFreqRange = Math.floor(dataArray.length * 0.15); // 15% for low
            const midFreqRange = Math.floor(dataArray.length * 0.4);  // 40% for mid

            for (let i = 0; i < dataArray.length; i++) {
                const value = dataArray[i] / 255; // Normalize to 0-1
                sumIntensity += value;

                if (i < lowFreqRange) {
                    lowFreqSum += value;
                } else if (i < midFreqRange) {
                    midFreqSum += value;
                }
            }

            // ç¸½éŸ³é‡ (Intensity) - å¹³å‡å¼·åº¦
            const intensity = sumIntensity / dataArray.length;

            // ç¯€æ‹ (Beat) - ä½é »å¹³å‡å¼·åº¦ (ç”¨æ–¼å°ºå¯¸è„ˆè¡)
            const beat = lowFreqSum / lowFreqRange; 

            // é »ç‡/éŸ³é«˜ (Frequency) - ä¸­é »å¹³å‡å¼·åº¦ (ç”¨æ–¼é¡è‰²è®ŠåŒ–)
            const frequency = midFreqSum / (midFreqRange - lowFreqRange);
            
            // å‹•ç•«é€Ÿåº¦ (Speed) - å–æ±ºæ–¼éŸ³é‡æˆ–è‡ªå®šç¾©æ»‘æ¡¿ (æš«æ™‚ä½¿ç”¨å›ºå®šå€¼)
            const speed = 1.0 + (intensity * 0.5); 

            return { beat: beat, frequency: frequency, intensity: intensity, speed: speed };
        }

        /**
         * The main animation loop.
         */
        function animate() {
            requestAnimationFrame(animate);

            // ç²å–çœŸå¯¦çš„éŸ³è¨Šæ•¸æ“š (å¦‚æœæ­£åœ¨æ’­æ”¾)
            const audioData = getRealAudioAnalysis();
            const { beat, frequency, intensity, speed } = audioData;

            // ç²å–ä½¿ç”¨è€…æ»‘æ¡¿å€¼ (å¾ 1-100 è½‰æ›ç‚º 0.01-1.00 çš„å½±éŸ¿ä¿‚æ•¸)
            const beatControl = parseFloat(document.getElementById('range-beat').value) / 100;
            const freqControl = parseFloat(document.getElementById('range-frequency').value) / 100;
            const densityControl = parseFloat(document.getElementById('range-intensity').value) / 100;
            const speedControl = parseFloat(document.getElementById('range-speed').value) / 100;

            // æ”å½±æ©ŸåŸºç¤æ—‹è½‰é€Ÿåº¦ (åŠ å¿«ï¼Œæ›´å®¹æ˜“çœ‹å‡ºå‹•ç•«æ˜¯å¦å•Ÿå‹•)
            const baseCamSpeed = 0.005;
            camera.rotation.y += baseCamSpeed * (1 + speedControl * 2);

            // å°‡éŸ³è¨Šæ•¸æ“šæ‡‰ç”¨åˆ°è¦–è¦ºæ•ˆæœ
            cubes.forEach((cube, index) => {
                
                // 1. ç¯€æ‹/éŸ»å¾‹ (Beat) â†’ å½¢ç‹€å°ºå¯¸ (Size)
                const scaleFactor = 1.0 + (beat * 1.0 * beatControl);
                cube.scale.setScalar(scaleFactor);

                // 2. å¼·åº¦/éŸ³é‡ (Intensity) â†’ ç²’å­å¯†åº¦ (Vertical movement/position)
                // åŸºç¤æ³¢æµªé€Ÿåº¦ï¼Œå³ä½¿æ²’æœ‰éŸ³æ¨‚ä¹Ÿåœ¨å‹•
                const baseWaveSpeed = 0.005; 
                const totalWaveSpeed = baseWaveSpeed + (0.003 * speed);

                // ä½¿ç”¨ Math.sin å‰µå»ºå‚ç›´æ³¢å‹•ï¼Œä¸¦å— Intensity/Density å½±éŸ¿
                cube.position.y = cube.initialY + (Math.sin(Date.now() * totalWaveSpeed + index * 0.5) * 0.5 * densityControl); 
                
                // 3. é »ç‡/éŸ³é«˜ (Frequency) â†’ é¡è‰²è®ŠåŒ– (Color Shift)
                // ä½¿ç”¨ HSL è¨­ç½®é¡è‰²ï¼Œè®“é¡è‰²è®ŠåŒ–æ›´å¹³æ»‘
                const h = (frequency * 0.7 + freqControl * 0.3) % 1; 
                const s = 0.8;
                const l = 0.5 + intensity * 0.3; 
                
                cube.material.color.setHSL(h, s, l);
                
                // 4. æ•´é«”å‹•ç•«é€Ÿåº¦ (Cube Rotation)
                const baseRotationSpeed = 0.01; // åŠ å¿«æ–¹å¡Šæ—‹è½‰é€Ÿåº¦
                cube.rotation.x += baseRotationSpeed * (1 + speed * speedControl);
                cube.rotation.y += baseRotationSpeed * (1 + speed * speedControl);
            });

            renderer.render(scene, camera);
        }

        /**
         * Handles window resizing to keep the visualization responsive.
         */
        function resizeRenderer() {
            const container = canvas.parentElement;
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            // Set canvas size
            canvas.width = width;
            canvas.height = height;

            // Update camera aspect ratio
            camera.aspect = width / height;
            camera.updateProjectionMatrix();

            // Update renderer size
            renderer.setSize(width, height);
        }

        // Initialize and start the loop
        window.addEventListener('resize', resizeRenderer);
        window.onload = function() {
            init();
            animate(); // Start the animation loop immediately
            updateButtonState(); // åˆå§‹åŒ–æŒ‰éˆ•ç‹€æ…‹
        };
    </script>
</body>
</html>
