<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ritaçš„å…±æ„Ÿå·¥ä½œå®¤ - éŸ³æ¨‚è¦–è¦ºåŒ–ç”Ÿæˆå™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        #visualization-canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        .control-group input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            background: #4B5563;
            border-radius: 4px;
        }
        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #6366F1;
            border-radius: 50%;
            cursor: pointer;
        }
        .preset-btn.active {
            background: #6366F1 !important;
            border-color: #818CF8 !important;
        }
        .style-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        #preview-image {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-top: 8px;
            max-height: 150px;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen antialiased">

    <div id="app" class="flex h-screen overflow-hidden">

        <!-- å·¦å´æ§åˆ¶é¢æ¿ -->
        <div class="w-full lg:w-1/3 xl:w-1/4 p-6 flex flex-col space-y-4 bg-gray-800 border-r border-gray-700 overflow-y-auto">
            
            <header class="pb-4 border-b border-gray-700">
                <h1 class="text-2xl font-extrabold text-indigo-400">å…±æ„Ÿå·¥ä½œå®¤</h1>
                <p class="text-xs text-gray-400 mt-1">éŸ³æ¨‚ Ã— è—è¡“ Ã— è¦–è¦ºåŒ–</p>
            </header>

            <!-- éŸ³æ¨‚è¼¸å…¥å€ -->
            <div class="space-y-2">
                <h2 class="text-lg font-semibold text-gray-200">ğŸµ è¼¸å…¥éŸ³æ¨‚</h2>
                <div class="flex flex-col space-y-2">
                    <input type="file" id="music-input" accept="audio/*" class="hidden" onchange="handleFileSelect(this.files)">
                    <label for="music-input" class="cursor-pointer bg-indigo-600 hover:bg-indigo-700 transition duration-150 text-white font-bold py-2 px-4 rounded-lg shadow-md flex items-center justify-center text-sm">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                        ä¸Šå‚³éŸ³æ¨‚
                    </label>
                    <p id="file-name" class="text-xs text-gray-400 italic">æœªé¸æ“‡æª”æ¡ˆ</p>
                    <audio id="audio-player" class="hidden" controls></audio>
                </div>
            </div>

            <!-- åœ–ç‰‡ä¸Šå‚³å€ -->
            <div class="space-y-2 pt-2 border-t border-gray-700">
                <h2 class="text-lg font-semibold text-gray-200">ğŸ–¼ï¸ ä¸Šå‚³åœ–ç‰‡ï¼ˆé¸æ“‡æ€§ï¼‰</h2>
                <input type="file" id="image-input" accept="image/*" class="hidden" onchange="handleImageSelect(this.files)">
                <label for="image-input" class="cursor-pointer bg-purple-600 hover:bg-purple-700 transition duration-150 text-white font-bold py-2 px-4 rounded-lg shadow-md flex items-center justify-center text-sm">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    ä¸Šå‚³åœ–ç‰‡
                </label>
                <img id="preview-image" class="hidden">
            </div>

            <!-- é è¨­é¢¨æ ¼ï¼ˆå¯æ»¾å‹•ï¼‰ -->
            <div class="space-y-2 pt-2 border-t border-gray-700">
                <h2 class="text-lg font-semibold text-gray-200">âœ¨ è¦–è¦ºé¢¨æ ¼ï¼ˆ12ç¨®ï¼‰</h2>
                <div class="style-grid">
                    <button class="preset-btn active bg-indigo-600 p-2 rounded-lg text-xs font-medium transition border-2 border-indigo-400" data-preset="neon">éœ“è™¹æ•…éšœ</button>
                    <button class="preset-btn bg-gray-700 p-2 rounded-lg text-xs font-medium transition border-2 border-transparent" data-preset="liquid">æµå‹•æ¶²æ…‹</button>
                    <button class="preset-btn bg-gray-700 p-2 rounded-lg text-xs font-medium transition border-2 border-transparent" data-preset="geometric">å¹¾ä½•æ³¢ç´‹</button>
                    <button class="preset-btn bg-gray-700 p-2 rounded-lg text-xs font-medium transition border-2 border-transparent" data-preset="particle">èƒ½é‡ç²’å­</button>
                    <button class="preset-btn bg-gray-700 p-2 rounded-lg text-xs font-medium transition border-2 border-transparent" data-preset="spectrum">é »è­œæŸ±ç‹€</button>
                    <button class="preset-btn bg-gray-700 p-2 rounded-lg text-xs font-medium transition border-2 border-transparent" data-preset="ripple">æ¼£æ¼ªæ³¢å‹•</button>
                    <button class="preset-btn bg-gray-700 p-2 rounded-lg text-xs font-medium transition border-2 border-transparent" data-preset="spiral">æ—‹è½‰èºæ—‹</button>
                    <button class="preset-btn bg-gray-700 p-2 rounded-lg text-xs font-medium transition border-2 border-transparent" data-preset="trail">å…‰è»Œè·¡</button>
                    <button class="preset-btn bg-gray-700 p-2 rounded-lg text-xs font-medium transition border-2 border-transparent" data-preset="mandelbrot">åˆ†å½¢è—è¡“</button>
                    <button class="preset-btn bg-gray-700 p-2 rounded-lg text-xs font-medium transition border-2 border-transparent" data-preset="plasma">é›»æ¼¿æ•ˆæ‡‰</button>
                    <button class="preset-btn bg-gray-700 p-2 rounded-lg text-xs font-medium transition border-2 border-transparent" data-preset="tunnel">æ˜Ÿå…‰éš§é“</button>
                    <button class="preset-btn bg-gray-700 p-2 rounded-lg text-xs font-medium transition border-2 border-transparent" data-preset="imagewave">åœ–ç‰‡æ³¢å‹•</button>
                </div>
            </div>

            <!-- åƒæ•¸æ§åˆ¶ -->
            <div class="space-y-2 pt-2 border-t border-gray-700">
                <h2 class="text-lg font-semibold text-gray-200">âš™ï¸ åƒæ•¸</h2>
                
                <div class="control-group">
                    <label class="block text-xs font-medium text-gray-300">ç¯€æ‹å¼·åº¦</label>
                    <input type="range" min="1" max="100" value="75" id="range-beat" class="w-full">
                </div>

                <div class="control-group">
                    <label class="block text-xs font-medium text-gray-300">é¡è‰²è®ŠåŒ–</label>
                    <input type="range" min="1" max="100" value="45" id="range-frequency" class="w-full">
                </div>
                
                <div class="control-group">
                    <label class="block text-xs font-medium text-gray-300">å¯†åº¦</label>
                    <input type="range" min="1" max="100" value="90" id="range-intensity" class="w-full">
                </div>
                
                <div class="control-group">
                    <label class="block text-xs font-medium text-gray-300">é€Ÿåº¦</label>
                    <input type="range" min="1" max="100" value="60" id="range-speed" class="w-full">
                </div>
            </div>

            <!-- å‹•ä½œæŒ‰éˆ• -->
            <div class="pt-2 border-t border-gray-700">
                <button id="start-btn" onclick="togglePlayback()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-lg text-sm shadow-xl transition">
                    â–¶ï¸ é–‹å§‹ç”Ÿæˆ
                </button>
            </div>
            
        </div>

        <!-- å³å´è¦–è¦ºè¼¸å‡ºå€ -->
        <div class="flex-1 relative bg-black">
            <h2 class="absolute top-4 left-4 z-10 text-lg font-bold text-white bg-black bg-opacity-50 px-3 py-1 rounded">
                ğŸ¨ è¦–è¦ºè¼¸å‡º
            </h2>
            <canvas id="visualization-canvas"></canvas>
            <canvas id="canvas-2d" style="display: none;"></canvas>
            
            <!-- æ’­æ”¾æ§åˆ¶ -->
            <div class="absolute bottom-0 w-full p-4 bg-gray-900 bg-opacity-70 flex justify-center items-center space-x-4">
                <button class="p-3 bg-gray-700 hover:bg-gray-600 rounded-full transition" onclick="document.getElementById('audio-player').currentTime -= 5">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                </button>
                <button id="play-pause-btn-bottom" class="p-4 bg-indigo-600 hover:bg-indigo-500 rounded-full transition" onclick="togglePlayback()">
                    <svg class="w-7 h-7 text-white" id="play-pause-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </button>
                <button class="p-3 bg-gray-700 hover:bg-gray-600 rounded-full transition" onclick="document.getElementById('audio-player').currentTime += 5">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                </button>
            </div>
        </div>

    </div>

    <script type="module">
        // â•â•â• å…¨åŸŸè®Šæ•¸ â•â•â•
        const canvas = document.getElementById('visualization-canvas');
        const canvas2D = document.getElementById('canvas-2d');
        const ctx2D = canvas2D.getContext('2d');
        const audioPlayer = document.getElementById('audio-player');
        const fileNameDisplay = document.getElementById('file-name');
        const startBtn = document.getElementById('start-btn');
        const playPauseIcon = document.getElementById('play-pause-icon');
        const previewImage = document.getElementById('preview-image');
        
        let scene, camera, renderer;
        let audioContext;
        let analyser;
        let dataArray;
        let isPlaying = false;
        let currentPreset = 'neon';
        let uploadedImage = null;
        
        // 3D ç‰©ä»¶
        let neonLines = [];
        let liquidMesh = null;
        let geometricShapes = [];
        let particleSystem = null;
        let trails = [];
        let spiralMeshes = [];

        // â•â•â• åœ–ç‰‡ä¸Šå‚³ â•â•â•
        window.handleImageSelect = function(files) {
            if (files.length > 0) {
                const file = files[0];
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        uploadedImage = img;
                        previewImage.src = img.src;
                        previewImage.classList.remove('hidden');
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        };

        // â•â•â• éŸ³è¨Šè™•ç† â•â•â•
        function setupAudioAnalysis() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                dataArray = new Uint8Array(analyser.frequencyBinCount);
                
                const source = audioContext.createMediaElementSource(audioPlayer);
                source.connect(analyser);
                analyser.connect(audioContext.destination);
            }
        }

        window.handleFileSelect = function(files) {
            if (files.length > 0) {
                const file = files[0];
                fileNameDisplay.textContent = file.name;
                audioPlayer.src = URL.createObjectURL(file);
                setupAudioAnalysis();
                isPlaying = false;
                updateButtonState();
            }
        };

        window.togglePlayback = function() {
            if (!audioPlayer.src) {
                startBtn.textContent = "âŒ è«‹å…ˆä¸Šå‚³æª”æ¡ˆ";
                setTimeout(() => updateButtonState(), 1500);
                return;
            }

            if (isPlaying) {
                audioPlayer.pause();
                isPlaying = false;
            } else {
                if (audioContext && audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                audioPlayer.play().catch(e => console.error("æ’­æ”¾å¤±æ•—:", e));
                isPlaying = true;
            }

            updateButtonState();
        };

        function updateButtonState() {
            if (isPlaying) {
                startBtn.innerHTML = 'â¸ï¸ æš«åœ';
                startBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                startBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                playPauseIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>`; 
            } else {
                startBtn.innerHTML = 'â–¶ï¸ é–‹å§‹ç”Ÿæˆ';
                startBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                startBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                playPauseIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>`;
            }
        }

        // â•â•â• éŸ³è¨Šæ•¸æ“š â•â•â•
        function getAudioData() {
            if (!analyser || !isPlaying) {
                return { beat: 0, mid: 0, high: 0, intensity: 0, data: new Uint8Array(128) };
            }

            analyser.getByteFrequencyData(dataArray);

            let beat = 0, mid = 0, high = 0, intensity = 0;
            
            for (let i = 0; i < Math.floor(dataArray.length * 0.15); i++) {
                beat += dataArray[i];
            }
            beat /= (Math.floor(dataArray.length * 0.15) || 1);
            beat /= 255;

            for (let i = Math.floor(dataArray.length * 0.15); i < Math.floor(dataArray.length * 0.4); i++) {
                mid += dataArray[i];
            }
            mid /= (Math.floor(dataArray.length * 0.25) || 1);
            mid /= 255;

            for (let i = Math.floor(dataArray.length * 0.4); i < dataArray.length; i++) {
                high += dataArray[i];
            }
            high /= (Math.floor(dataArray.length * 0.6) || 1);
            high /= 255;

            for (let i = 0; i < dataArray.length; i++) {
                intensity += dataArray[i];
            }
            intensity /= (dataArray.length * 255);

            return { beat, mid, high, intensity, data: dataArray };
        }

        // â•â•â• Three.js åˆå§‹åŒ– â•â•â•
        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0a0a);

            camera = new THREE.PerspectiveCamera(75, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
            camera.position.z = 2;

            renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
            resizeRenderer();

            const light = new THREE.AmbientLight(0xffffff, 2);
            scene.add(light);

            window.addEventListener('resize', resizeRenderer);

            // 2D Canvas
            canvas2D.width = canvas.width;
            canvas2D.height = canvas.height;
        }

        function resizeRenderer() {
            const container = canvas.parentElement;
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            canvas.width = width;
            canvas.height = height;
            canvas2D.width = width;
            canvas2D.height = height;

            camera.aspect = width / height;
            camera.updateProjectionMatrix();

            renderer.setSize(width, height);
        }

        // â•â•â• é¢¨æ ¼1ï¼šéœ“è™¹æ•…éšœ â•â•â•
        function setupNeon() {
            scene.children = [];
            neonLines = [];
            for (let i = 0; i < 8; i++) {
                const geometry = new THREE.BufferGeometry();
                const points = [];
                for (let x = -1; x <= 1; x += 0.05) {
                    points.push(new THREE.Vector3(x, Math.random() * 0.5, 0));
                }
                geometry.setFromPoints(points);
                const material = new THREE.LineBasicMaterial({ color: 0x00ff00 });
                const line = new THREE.Line(geometry, material);
                line.position.y = -1 + i * 0.3;
                scene.add(line);
                neonLines.push({ line, geometry, points });
            }
        }

        function updateNeon(audioData) {
            const { beat, high } = audioData;
            const beatControl = parseFloat(document.getElementById('range-beat').value) / 100;
            neonLines.forEach((item, idx) => {
                const { line, points } = item;
                const hue = (high * 0.7 + Date.now() / 10000 + idx * 0.1) % 1;
                line.material.color.setHSL(hue, 1, 0.5);
                points.forEach((point, pIdx) => {
                    point.y += (Math.sin(Date.now() / 300 + pIdx * 0.1) * 0.05 * beat * beatControl);
                });
                line.geometry.setFromPoints(points);
                line.geometry.verticesNeedUpdate = true;
                if (Math.random() > 0.8) {
                    line.position.x = (Math.random() - 0.5) * 0.2;
                }
            });
        }

        // â•â•â• é¢¨æ ¼2ï¼šæµå‹•æ¶²æ…‹ â•â•â•
        function setupLiquid() {
            scene.children = [];
            const geometry = new THREE.IcosahedronGeometry(1, 8);
            const material = new THREE.MeshPhongMaterial({
                color: 0x00ffff,
                emissive: 0x0088ff,
                wireframe: false
            });
            liquidMesh = new THREE.Mesh(geometry, material);
            scene.add(liquidMesh);
        }

        function updateLiquid(audioData) {
            const { beat, mid } = audioData;
            const speedControl = parseFloat(document.getElementById('range-speed').value) / 100;
            if (liquidMesh) {
                liquidMesh.rotation.x += beat * 0.1 + speedControl * 0.01;
                liquidMesh.rotation.y += mid * 0.1 + speedControl * 0.01;
                liquidMesh.scale.setScalar(1 + beat * 0.5);
                const hue = (mid + Date.now() / 5000) % 1;
                liquidMesh.material.color.setHSL(hue, 1, 0.5);
            }
        }

        // â•â•â• é¢¨æ ¼3ï¼šå¹¾ä½•æ³¢ç´‹ â•â•â•
        function setupGeometric() {
            scene.children = [];
            geometricShapes = [];
            for (let i = 0; i < 12; i++) {
                const geometry = new THREE.OctahedronGeometry(0.3, 2);
                const material = new THREE.MeshPhongMaterial({
                    color: new THREE.Color().setHSL(i / 12, 1, 0.5)
                });
                const mesh = new THREE.Mesh(geometry, material);
                const angle = (i / 12) * Math.PI * 2;
                mesh.position.x = Math.cos(angle) * 1.5;
                mesh.position.y = Math.sin(angle) * 1.5;
                scene.add(mesh);
                geometricShapes.push({
                    mesh,
                    angle,
                    initialRadius: 1.5
                });
            }
        }

        function updateGeometric(audioData) {
            const { beat, high, intensity } = audioData;
            const intensityControl = parseFloat(document.getElementById('range-intensity').value) / 100;
            geometricShapes.forEach((shape, idx) => {
                const radius = shape.initialRadius + beat * 0.5 * intensityControl;
                shape.mesh.position.x = Math.cos(shape.angle) * radius;
                shape.mesh.position.y = Math.sin(shape.angle) * radius;
                shape.mesh.rotation.x += high * 0.05;
                shape.mesh.rotation.y += high * 0.05;
                shape.mesh.scale.setScalar(1 + intensity * 0.3);
                const hue = (idx / 12 + high + Date.now() / 5000) % 1;
                shape.mesh.material.color.setHSL(hue, 1, 0.5);
            });
        }

        // â•â•â• é¢¨æ ¼4ï¼šç²’å­ â•â•â•
        function setupParticles() {
            scene.children = [];
            const particlesCount = 1000;
            const geometry = new THREE.BufferGeometry();
            const positions = new Float32Array(particlesCount * 3);
            const colors = new Float32Array(particlesCount * 3);

            for (let i = 0; i < particlesCount; i++) {
                positions[i * 3] = (Math.random() - 0.5) * 4;
                positions[i * 3 + 1] = (Math.random() - 0.5) * 4;
                positions[i * 3 + 2] = (Math.random() - 0.5) * 4;
                colors[i * 3] = Math.random();
                colors[i * 3 + 1] = Math.random();
                colors[i * 3 + 2] = Math.random();
            }

            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
            const material = new THREE.PointsMaterial({
                size: 0.02,
                vertexColors: true
            });
            particleSystem = new THREE.Points(geometry, material);
            scene.add(particleSystem);
        }

        function updateParticles(audioData) {
            const { beat, mid, intensity } = audioData;
            const speedControl = parseFloat(document.getElementById('range-speed').value) / 100;
            if (particleSystem) {
                const positions = particleSystem.geometry.attributes.position.array;
                for (let i = 0; i < positions.length; i += 3) {
                    positions[i] += (Math.random() - 0.5) * intensity * 0.1;
                    positions[i + 1] += (Math.random() - 0.5) * beat * 0.1;
                    positions[i + 2] += (Math.random() - 0.5) * mid * 0.1;
                }
                particleSystem.geometry.attributes.position.needsUpdate = true;
                particleSystem.rotation.x += speedControl * 0.01;
                particleSystem.rotation.y += speedControl * 0.01;
            }
        }

        // â•â•â• é¢¨æ ¼5ï¼šé »è­œæŸ±ç‹€ â•â•â•
        function setupSpectrum() {
            scene.children = [];
            const count = 32;
            for (let i = 0; i < count; i++) {
                const geometry = new THREE.BoxGeometry(0.08, 1, 0.08);
                const material = new THREE.MeshPhongMaterial({
                    color: new THREE.Color().setHSL(i / count, 1, 0.5)
                });
                const mesh = new THREE.Mesh(geometry, material);
                const angle = (i / count) * Math.PI * 2;
                mesh.position.x = Math.cos(angle) * 1.5;
                mesh.position.z = Math.sin(angle) * 1.5;
                mesh.position.y = 0;
                scene.add(mesh);
                geometricShapes.push({ mesh, angle });
            }
            geometricShapes = [];
        }

        function updateSpectrum(audioData) {
            const { data } = audioData;
            const count = 32;
            if (scene.children.length !== count + 1) setupSpectrum();
            
            for (let i = 0; i < count; i++) {
                const mesh = scene.children[i];
                const value = data[Math.floor(i * data.length / count)] / 255;
                mesh.scale.y = 0.5 + value;
                const hue = (i / count + Date.now() / 5000) % 1;
                mesh.material.color.setHSL(hue, 1, 0.5 + value * 0.3);
            }
        }

        // â•â•â• é¢¨æ ¼6ï¼šæ¼£æ¼ªæ³¢å‹• â•â•â•
        function setupRipple() {
            scene.children = [];
            const geometry = new THREE.PlaneGeometry(4, 4, 32, 32);
            const material = new THREE.MeshPhongMaterial({
                color: 0x00ffff,
                wireframe: true,
                emissive: 0x0088ff
            });
            liquidMesh = new THREE.Mesh(geometry, material);
            scene.add(liquidMesh);
        }

        function updateRipple(audioData) {
            const { beat, intensity } = audioData;
            if (liquidMesh && liquidMesh.geometry.attributes.position) {
                const positions = liquidMesh.geometry.attributes.position.array;
                const originalPositions = liquidMesh.userData.originalPositions;
                
                if (!originalPositions) {
                    liquidMesh.userData.originalPositions = new Float32Array(positions);
                }

                const time = Date.now() * 0.001;
                for (let i = 0; i < positions.length; i += 3) {
                    const x = originalPositions[i];
                    const y = originalPositions[i + 1];
                    const dist = Math.sqrt(x * x + y * y);
                    positions[i + 2] = Math.sin(dist * 10 - time * 5) * (0.2 + beat * 0.5) + intensity * 0.2;
                }
                liquidMesh.geometry.attributes.position.needsUpdate = true;
                liquidMesh.geometry.computeVertexNormals();
            }
        }

        // â•â•â• é¢¨æ ¼7ï¼šæ—‹è½‰èºæ—‹ â•â•â•
        function setupSpiral() {
            scene.children = [];
            spiralMeshes = [];
            const layers = 5;
            for (let layer = 0; layer < layers; layer++) {
                const count = 20 + layer * 5;
                for (let i = 0; i < count; i++) {
                    const geometry = new THREE.SphereGeometry(0.15, 8, 8);
                    const material = new THREE.MeshPhongMaterial({
                        color: new THREE.Color().setHSL((layer / layers + i / count) % 1, 1, 0.5)
                    });
                    const mesh = new THREE.Mesh(geometry, material);
                    const angle = (i / count) * Math.PI * 2;
                    const radius = 0.5 + layer * 0.4;
                    mesh.position.x = Math.cos(angle) * radius;
                    mesh.position.y = Math.sin(angle) * radius;
                    mesh.position.z = (layer - layers / 2) * 0.5;
                    scene.add(mesh);
                    spiralMeshes.push({ mesh, layer, i });
                }
            }
        }

        function updateSpiral(audioData) {
            const { beat, high } = audioData;
            const speedControl = parseFloat(document.getElementById('range-speed').value) / 100;
            
            spiralMeshes.forEach(item => {
                const time = Date.now() * 0.001 * (1 + speedControl);
                item.mesh.rotation.x += high * 0.05;
                item.mesh.rotation.y += beat * 0.05;
                item.mesh.scale.setScalar(1 + beat * 0.3);
                const hue = (item.layer / 5 + time * 0.5 + high) % 1;
                item.mesh.material.color.setHSL(hue, 1, 0.5);
            });
        }

        // â•â•â• é¢¨æ ¼8ï¼šå…‰è»Œè·¡ â•â•â•
        function setupTrail() {
            scene.children = [];
            trails = [];
            for (let i = 0; i < 5; i++) {
                const geometry = new THREE.TubeGeometry(
                    new THREE.CatmullRomCurve3([
                        new THREE.Vector3(-1, 0, 0),
                        new THREE.Vector3(0, 1, 0),
                        new THREE.Vector3(1, 0, 0)
                    ]),
                    20, 0.1, 8, false
                );
                const material = new THREE.MeshPhongMaterial({
                    color: new THREE.Color().setHSL(i / 5, 1, 0.5),
                    emissive: new THREE.Color().setHSL(i / 5, 1, 0.3)
                });
                const mesh = new THREE.Mesh(geometry, material);
                mesh.rotation.z = (i / 5) * Math.PI * 2;
                scene.add(mesh);
                trails.push(mesh);
            }
        }

        function updateTrail(audioData) {
            const { beat, mid } = audioData;
            trails.forEach((mesh, idx) => {
                mesh.rotation.z += beat * 0.05;
                mesh.rotation.x += mid * 0.05;
                mesh.scale.setScalar(1 + beat * 0.5);
                const hue = (idx / 5 + Date.now() / 5000) % 1;
                mesh.material.color.setHSL(hue, 1, 0.5);
            });
        }

        // â•â•â• é¢¨æ ¼9ï¼šåˆ†å½¢è—è¡“ â•â•â•
        function updateMandelbrot(audioData) {
            const { intensity, high } = audioData;
            ctx2D.fillStyle = '#0a0a0a';
            ctx2D.fillRect(0, 0, canvas2D.width, canvas2D.height);

            const w = canvas2D.width;
            const h = canvas2D.height;
            const scale = 0.5 + intensity * 2;
            const centerX = 0.5 + high * 0.3;
            const centerY = 0.5;

            for (let x = 0; x < w; x += 4) {
                for (let y = 0; y < h; y += 4) {
                    const realPart = (x / w - 0.5) / scale + centerX;
                    const imagPart = (y / h - 0.5) / scale + centerY;

                    let real = realPart;
                    let imag = imagPart;
                    let iterations = 0;

                    for (let i = 0; i < 50; i++) {
                        const realSquared = real * real;
                        const imagSquared = imag * imag;

                        if (realSquared + imagSquared > 4) break;

                        const temp = realSquared - imagSquared + realPart;
                        imag = 2 * real * imag + imagPart;
                        real = temp;
                        iterations++;
                    }

                    const hue = (iterations / 50 + Date.now() / 5000) % 1;
                    const rgb = hslToRgb(hue, 1, 0.5);
                    ctx2D.fillStyle = `rgb(${rgb[0]}, ${rgb[1]}, ${rgb[2]})`;
                    ctx2D.fillRect(x, y, 4, 4);
                }
            }
        }

        // â•â•â• é¢¨æ ¼10ï¼šé›»æ¼¿ â•â•â•
        function updatePlasma(audioData) {
            const { intensity, high, beat } = audioData;
            ctx2D.fillStyle = '#0a0a0a';
            ctx2D.fillRect(0, 0, canvas2D.width, canvas2D.height);

            const time = Date.now() * 0.001;
            const w = canvas2D.width;
            const h = canvas2D.height;

            for (let x = 0; x < w; x += 4) {
                for (let y = 0; y < h; y += 4) {
                    const value = Math.sin((x + time * 100) * 0.01) +
                                 Math.sin((y + time * 50) * 0.01) +
                                 Math.sin((x + y + time * 70) * 0.01) +
                                 Math.sin(Math.sqrt(x * x + y * y) * 0.01 + time * 50) * beat;

                    const hue = (value * 0.3 + high + Date.now() / 5000) % 1;
                    const rgb = hslToRgb(hue, 1, 0.5);
                    ctx2D.fillStyle = `rgb(${rgb[0]}, ${rgb[1]}, ${rgb[2]})`;
                    ctx2D.fillRect(x, y, 4, 4);
                }
            }
        }

        // â•â•â• é¢¨æ ¼11ï¼šæ˜Ÿå…‰éš§é“ â•â•â•
        function setupTunnel() {
            scene.children = [];
            const layers = 10;
            for (let layer = 0; layer < layers; layer++) {
                const count = 12 + layer * 2;
                for (let i = 0; i < count; i++) {
                    const geometry = new THREE.SphereGeometry(0.05, 8, 8);
                    const material = new THREE.MeshPhongMaterial({
                        color: new THREE.Color().setHSL(layer / layers, 1, 0.7),
                        emissive: new THREE.Color().setHSL(layer / layers, 1, 0.5)
                    });
                    const mesh = new THREE.Mesh(geometry, material);
                    const angle = (i / count) * Math.PI * 2;
                    const radius = 0.2 + layer * 0.2;
                    mesh.position.x = Math.cos(angle) * radius;
                    mesh.position.y = Math.sin(angle) * radius;
                    mesh.position.z = -2 + layer * 0.5;
                    scene.add(mesh);
                }
            }
        }

        function updateTunnel(audioData) {
            const { beat, intensity } = audioData;
            const speedControl = parseFloat(document.getElementById('range-speed').value) / 100;

            scene.children.forEach((mesh) => {
                mesh.position.z += (0.05 + speedControl * 0.05);
                if (mesh.position.z > 0) {
                    mesh.position.z = -2;
                }
                mesh.scale.setScalar(1 + beat * 0.3 + intensity * 0.2);
            });
        }

        // â•â•â• é¢¨æ ¼12ï¼šåœ–ç‰‡æ³¢å‹• â•â•â•
        function updateImageWave(audioData) {
            const { beat, intensity } = audioData;
            
            if (!uploadedImage) {
                ctx2D.fillStyle = '#0a0a0a';
                ctx2D.fillRect(0, 0, canvas2D.width, canvas2D.height);
                return;
            }

            const w = canvas2D.width;
            const h = canvas2D.height;
            const imgW = uploadedImage.width;
            const imgH = uploadedImage.height;

            ctx2D.clearRect(0, 0, w, h);
            ctx2D.save();
            ctx2D.globalAlpha = 0.8 + intensity * 0.2;

            // ç¹ªè£½åŸå§‹åœ–ç‰‡
            const scale = Math.min(w / imgW, h / imgH);
            ctx2D.drawImage(uploadedImage, (w - imgW * scale) / 2, (h - imgH * scale) / 2, imgW * scale, imgH * scale);

            // æ·»åŠ æ³¢ç´‹æ•ˆæœ
            ctx2D.strokeStyle = `hsl(${(beat * 360) % 360}, 100%, 50%)`;
            ctx2D.lineWidth = 2;
            ctx2D.beginPath();
            for (let x = 0; x < w; x += 10) {
                const y = h / 2 + Math.sin(x * 0.01 + Date.now() * 0.001) * beat * 50;
                x === 0 ? ctx2D.moveTo(x, y) : ctx2D.lineTo(x, y);
            }
            ctx2D.stroke();

            ctx2D.restore();
        }

        // â•â•â• è‰²å½©è½‰æ›å‡½æ•¸ â•â•â•
        function hslToRgb(h, s, l) {
            let r, g, b;
            if (s === 0) {
                r = g = b = l;
            } else {
                const hue2rgb = (p, q, t) => {
                    if (t < 0) t += 1;
                    if (t > 1) t -= 1;
                    if (t < 1/6) return p + (q - p) * 6 * t;
                    if (t < 1/2) return q;
                    if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                    return p;
                };
                const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                const p = 2 * l - q;
                r = hue2rgb(p, q, h + 1/3);
                g = hue2rgb(p, q, h);
                b = hue2rgb(p, q, h - 1/3);
            }
            return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];
        }

        // â•â•â• é è¨­é¢¨æ ¼åˆ‡æ› â•â•â•
        document.querySelectorAll('.preset-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.preset-btn').forEach(b => {
                    b.classList.remove('active', 'bg-indigo-600', 'border-indigo-400');
                    b.classList.add('bg-gray-700', 'border-transparent');
                });
                
                btn.classList.add('active', 'bg-indigo-600', 'border-indigo-400');
                btn.classList.remove('bg-gray-700', 'border-transparent');

                currentPreset = btn.dataset.preset;
                
                switch(currentPreset) {
                    case 'neon': setupNeon(); break;
                    case 'liquid': setupLiquid(); break;
                    case 'geometric': setupGeometric(); break;
                    case 'particle': setupParticles(); break;
                    case 'spiral': setupSpiral(); break;
                    case 'trail': setupTrail(); break;
                    case 'tunnel': setupTunnel(); break;
                }
            });
        });

        // â•â•â• å‹•ç•«å¾ªç’° â•â•â•
        function animate() {
            requestAnimationFrame(animate);

            const audioData = getAudioData();

            switch(currentPreset) {
                case 'neon': updateNeon(audioData); break;
                case 'liquid': updateLiquid(audioData); break;
                case 'geometric': updateGeometric(audioData); break;
                case 'particle': updateParticles(audioData); break;
                case 'spectrum': updateSpectrum(audioData); break;
                case 'ripple': updateRipple(audioData); break;
                case 'spiral': updateSpiral(audioData); break;
                case 'trail': updateTrail(audioData); break;
                case 'mandelbrot': updateMandelbrot(audioData); break;
                case 'plasma': updatePlasma(audioData); break;
                case 'tunnel': updateTunnel(audioData); break;
                case 'imagewave': updateImageWave(audioData); break;
            }

            // åªåœ¨ä½¿ç”¨ 3D é¢¨æ ¼æ™‚æ¸²æŸ“ three.js
            if (['mandelbrot', 'plasma', 'imagewave'].includes(currentPreset)) {
                // åªé¡¯ç¤º 2D Canvas
            } else {
                renderer.render(scene, camera);
            }
        }

        // åˆå§‹åŒ–
        window.onload = function() {
            init();
            setupNeon();
            animate();
            updateButtonState();
        };
    </script>
</body>
</html>
