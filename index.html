<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…±æ„Ÿå·¥ä½œå®¤ - éŸ³æ¨‚è¦–è¦ºåŒ–ç”Ÿæˆå™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        #visualization-canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        .control-group input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            background: #4B5563;
            border-radius: 4px;
        }
        .control-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #6366F1;
            border-radius: 50%;
            cursor: pointer;
        }
        .preset-btn.active {
            background: #6366F1 !important;
            border-color: #818CF8 !important;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen antialiased">

    <div id="app" class="flex h-screen overflow-hidden">

        <!-- å·¦å´æ§åˆ¶é¢æ¿ -->
        <div class="w-full lg:w-1/3 xl:w-1/4 p-6 flex flex-col space-y-6 bg-gray-800 border-r border-gray-700 overflow-y-auto">
            
            <header class="pb-4 border-b border-gray-700">
                <h1 class="text-3xl font-extrabold text-indigo-400">å…±æ„Ÿå·¥ä½œå®¤</h1>
                <p class="text-sm text-gray-400 mt-1">å°‡éŸ³æ¨‚è½‰åŒ–ç‚ºç”Ÿæˆè—è¡“</p>
            </header>

            <!-- éŸ³æ¨‚è¼¸å…¥å€ -->
            <div class="space-y-4">
                <h2 class="text-xl font-semibold text-gray-200">ğŸµ è¼¸å…¥éŸ³æ¨‚</h2>
                <div class="flex flex-col space-y-3">
                    <input type="file" id="music-input" accept="audio/*" class="hidden" onchange="handleFileSelect(this.files)">
                    <label for="music-input" class="cursor-pointer bg-indigo-600 hover:bg-indigo-700 transition duration-150 text-white font-bold py-2 px-4 rounded-lg shadow-md flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                        ä¸Šå‚³æˆ–é¸æ“‡æ­Œæ›² (.mp3 / .wav)
                    </label>
                    <p id="file-name" class="text-sm text-gray-400 italic">æœªé¸æ“‡æª”æ¡ˆ</p>
                    <audio id="audio-player" class="hidden" controls></audio>
                </div>
            </div>

            <!-- é è¨­é¢¨æ ¼ -->
            <div class="space-y-4 pt-4 border-t border-gray-700">
                <h2 class="text-xl font-semibold text-gray-200">âœ¨ é¸æ“‡é è¨­é¢¨æ ¼</h2>
                <div class="grid grid-cols-2 gap-3">
                    <button class="preset-btn active bg-indigo-600 p-3 rounded-lg text-sm font-medium transition duration-150 border-2 border-indigo-400" data-preset="neon">éœ“è™¹æ•…éšœé¢¨</button>
                    <button class="preset-btn bg-gray-700 hover:bg-gray-600 p-3 rounded-lg text-sm font-medium transition duration-150 border-2 border-transparent" data-preset="liquid">æµå‹•æ¶²æ…‹</button>
                    <button class="preset-btn bg-gray-700 hover:bg-gray-600 p-3 rounded-lg text-sm font-medium transition duration-150 border-2 border-transparent" data-preset="geometric">å¹¾ä½•æ³¢ç´‹</button>
                    <button class="preset-btn bg-gray-700 hover:bg-gray-600 p-3 rounded-lg text-sm font-medium transition duration-150 border-2 border-transparent" data-preset="particle">èƒ½é‡ç²’å­</button>
                </div>
            </div>

            <!-- åƒæ•¸æ§åˆ¶ -->
            <div class="space-y-4 pt-4 border-t border-gray-700">
                <h2 class="text-xl font-semibold text-gray-200">âš™ï¸ å³æ™‚åƒæ•¸èª¿æ•´</h2>
                
                <div class="control-group">
                    <label class="block text-sm font-medium text-gray-300">ç¯€æ‹å¼·åº¦</label>
                    <input type="range" min="1" max="100" value="75" id="range-beat" class="w-full">
                </div>

                <div class="control-group">
                    <label class="block text-sm font-medium text-gray-300">é¡è‰²è®ŠåŒ–</label>
                    <input type="range" min="1" max="100" value="45" id="range-frequency" class="w-full">
                </div>
                
                <div class="control-group">
                    <label class="block text-sm font-medium text-gray-300">å¯†åº¦/è©³ç´°åº¦</label>
                    <input type="range" min="1" max="100" value="90" id="range-intensity" class="w-full">
                </div>
                
                <div class="control-group">
                    <label class="block text-sm font-medium text-gray-300">å‹•ç•«é€Ÿåº¦</label>
                    <input type="range" min="1" max="100" value="60" id="range-speed" class="w-full">
                </div>
            </div>

            <!-- å‹•ä½œæŒ‰éˆ• -->
            <div class="pt-6 border-t border-gray-700">
                <button id="start-btn" onclick="togglePlayback()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg text-lg shadow-xl transition duration-150 ease-in-out transform hover:scale-[1.02] active:scale-[0.98]">
                    â–¶ï¸ é–‹å§‹ç”Ÿæˆ
                </button>
            </div>
            
        </div>

        <!-- å³å´è¦–è¦ºè¼¸å‡ºå€ -->
        <div class="flex-1 relative bg-black">
            <h2 class="absolute top-4 left-4 z-10 text-xl font-bold text-white bg-black bg-opacity-50 px-3 py-1 rounded-lg">
                ğŸ¨ å³æ™‚è¦–è¦ºè¼¸å‡º
            </h2>
            <canvas id="visualization-canvas"></canvas>
            
            <!-- æ’­æ”¾æ§åˆ¶ -->
            <div class="absolute bottom-0 w-full p-4 bg-gray-900 bg-opacity-70 flex justify-center items-center space-x-4">
                <button class="p-3 bg-gray-700 hover:bg-gray-600 rounded-full transition duration-150" onclick="document.getElementById('audio-player').currentTime -= 5">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                </button>
                <button id="play-pause-btn-bottom" class="p-4 bg-indigo-600 hover:bg-indigo-500 rounded-full transition duration-150" onclick="togglePlayback()">
                    <svg class="w-8 h-8 text-white" id="play-pause-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </button>
                <button class="p-3 bg-gray-700 hover:bg-gray-600 rounded-full transition duration-150" onclick="document.getElementById('audio-player').currentTime += 5">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                </button>
            </div>
        </div>

    </div>

    <script type="module">
        // â•â•â• å…¨åŸŸè®Šæ•¸ â•â•â•
        const canvas = document.getElementById('visualization-canvas');
        const audioPlayer = document.getElementById('audio-player');
        const fileNameDisplay = document.getElementById('file-name');
        const startBtn = document.getElementById('start-btn');
        const playPauseIcon = document.getElementById('play-pause-icon');
        
        let scene, camera, renderer;
        let audioContext;
        let analyser;
        let dataArray;
        let isPlaying = false;
        let currentPreset = 'neon';
        
        // ä¸åŒé è¨­çš„ç‰©ä»¶é›†åˆ
        let neonLines = [];
        let liquidMesh = null;
        let geometricShapes = [];
        let particles = [];
        let particleSystem = null;

        // â•â•â• éŸ³è¨Šè™•ç† â•â•â•
        function setupAudioAnalysis() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                dataArray = new Uint8Array(analyser.frequencyBinCount);
                
                const source = audioContext.createMediaElementSource(audioPlayer);
                source.connect(analyser);
                analyser.connect(audioContext.destination);
            }
        }

        window.handleFileSelect = function(files) {
            if (files.length > 0) {
                const file = files[0];
                fileNameDisplay.textContent = file.name;
                audioPlayer.src = URL.createObjectURL(file);
                setupAudioAnalysis();
                isPlaying = false;
                updateButtonState();
            } else {
                fileNameDisplay.textContent = 'æœªé¸æ“‡æª”æ¡ˆ';
                audioPlayer.src = '';
            }
        };

        window.togglePlayback = function() {
            if (!audioPlayer.src) {
                startBtn.textContent = "âŒ è«‹å…ˆä¸Šå‚³æª”æ¡ˆ";
                setTimeout(() => updateButtonState(), 1500);
                return;
            }

            if (isPlaying) {
                audioPlayer.pause();
                isPlaying = false;
            } else {
                if (audioContext && audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                audioPlayer.play().catch(e => console.error("æ’­æ”¾å¤±æ•—:", e));
                isPlaying = true;
            }

            updateButtonState();
        };

        function updateButtonState() {
            if (isPlaying) {
                startBtn.innerHTML = 'â¸ï¸ æš«åœç”Ÿæˆ';
                startBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                startBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                playPauseIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>`; 
            } else {
                startBtn.innerHTML = 'â–¶ï¸ é–‹å§‹ç”Ÿæˆ';
                startBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                startBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                playPauseIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>`;
            }
        }

        // â•â•â• ç²å–éŸ³è¨Šæ•¸æ“š â•â•â•
        function getAudioData() {
            if (!analyser || !isPlaying) {
                return { beat: 0, mid: 0, high: 0, intensity: 0 };
            }

            analyser.getByteFrequencyData(dataArray);

            let beat = 0, mid = 0, high = 0, intensity = 0;
            
            // ä½é » (ç¯€æ‹)
            for (let i = 0; i < Math.floor(dataArray.length * 0.15); i++) {
                beat += dataArray[i];
            }
            beat /= (Math.floor(dataArray.length * 0.15) || 1);
            beat /= 255;

            // ä¸­é »
            for (let i = Math.floor(dataArray.length * 0.15); i < Math.floor(dataArray.length * 0.4); i++) {
                mid += dataArray[i];
            }
            mid /= (Math.floor(dataArray.length * 0.25) || 1);
            mid /= 255;

            // é«˜é »
            for (let i = Math.floor(dataArray.length * 0.4); i < dataArray.length; i++) {
                high += dataArray[i];
            }
            high /= (Math.floor(dataArray.length * 0.6) || 1);
            high /= 255;

            // ç¸½å¼·åº¦
            for (let i = 0; i < dataArray.length; i++) {
                intensity += dataArray[i];
            }
            intensity /= (dataArray.length * 255);

            return { beat, mid, high, intensity };
        }

        // â•â•â• Three.js åˆå§‹åŒ– â•â•â•
        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0a0a);

            camera = new THREE.PerspectiveCamera(75, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
            camera.position.z = 2;

            renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
            resizeRenderer();

            const light = new THREE.AmbientLight(0xffffff, 2);
            scene.add(light);

            window.addEventListener('resize', resizeRenderer);
        }

        function resizeRenderer() {
            const container = canvas.parentElement;
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            canvas.width = width;
            canvas.height = height;

            camera.aspect = width / height;
            camera.updateProjectionMatrix();

            renderer.setSize(width, height);
        }

        // â•â•â• é è¨­é¢¨æ ¼ï¼šéœ“è™¹æ•…éšœé¢¨ â•â•â•
        function setupNeonGlitch() {
            // æ¸…ç©ºå ´æ™¯
            scene.children.forEach(child => {
                if (child !== camera) scene.remove(child);
            });
            neonLines = [];

            // å‰µå»ºå¤šæ¢ç·š
            for (let i = 0; i < 8; i++) {
                const geometry = new THREE.BufferGeometry();
                const points = [];
                for (let x = -1; x <= 1; x += 0.05) {
                    points.push(new THREE.Vector3(x, Math.random() * 0.5, 0));
                }
                geometry.setFromPoints(points);

                const material = new THREE.LineBasicMaterial({ color: 0x00ff00, linewidth: 2 });
                const line = new THREE.Line(geometry, material);
                line.position.y = -1 + i * 0.3;
                scene.add(line);
                neonLines.push({ line, geometry, points });
            }
        }

        function updateNeonGlitch(audioData) {
            const { beat, high, intensity } = audioData;
            const beatControl = parseFloat(document.getElementById('range-beat').value) / 100;
            const freqControl = parseFloat(document.getElementById('range-frequency').value) / 100;

            neonLines.forEach((item, idx) => {
                const { line, points } = item;
                
                // æ›´æ–°ç·šçš„é¡è‰² (é »ç‡æ§åˆ¶)
                const hue = (high * 0.7 + freqControl * 0.3 + Date.now() / 10000 + idx * 0.1) % 1;
                line.material.color.setHSL(hue, 1, 0.5);

                // æ›´æ–°ç·šçš„å½¢ç‹€ (ç¯€æ‹æ§åˆ¶)
                points.forEach((point, pIdx) => {
                    point.y += (Math.sin(Date.now() / 300 + pIdx * 0.1) * 0.05 * beat * beatControl);
                });
                line.geometry.setFromPoints(points);
                line.geometry.verticesNeedUpdate = true;

                // æ•…éšœæ•ˆæœ (éš¨æ©Ÿåç§»)
                if (Math.random() > 0.8) {
                    line.position.x = (Math.random() - 0.5) * 0.2;
                }
            });

            // è¢å¹•é–ƒçˆ
            if (intensity > 0.7 && Math.random() > 0.7) {
                renderer.setClearColor(0xff00ff, 0.1);
            } else {
                renderer.setClearColor(0x0a0a0a, 1);
            }
        }

        // â•â•â• é è¨­é¢¨æ ¼ï¼šæµå‹•æ¶²æ…‹ â•â•â•
        function setupLiquidFlow() {
            scene.children.forEach(child => {
                if (child !== camera) scene.remove(child);
            });

            const geometry = new THREE.IcosahedronGeometry(1, 8);
            const material = new THREE.MeshPhongMaterial({
                color: 0x00ffff,
                emissive: 0x0088ff,
                shininess: 100,
                wireframe: false
            });

            liquidMesh = new THREE.Mesh(geometry, material);
            scene.add(liquidMesh);
        }

        function updateLiquidFlow(audioData) {
            const { beat, mid, intensity } = audioData;
            const speedControl = parseFloat(document.getElementById('range-speed').value) / 100;

            if (liquidMesh) {
                // å½¢ç‹€è®Šå½¢
                liquidMesh.rotation.x += beat * 0.1 + speedControl * 0.01;
                liquidMesh.rotation.y += mid * 0.1 + speedControl * 0.01;
                
                // å°ºå¯¸è„ˆè¡
                liquidMesh.scale.setScalar(1 + beat * 0.5);

                // é¡è‰²æ¼¸è®Š
                const hue = (mid + Date.now() / 5000) % 1;
                liquidMesh.material.color.setHSL(hue, 1, 0.5);
                liquidMesh.material.emissive.setHSL(hue, 1, 0.3);
            }
        }

        // â•â•â• é è¨­é¢¨æ ¼ï¼šå¹¾ä½•æ³¢ç´‹ â•â•â•
        function setupGeometricWave() {
            scene.children.forEach(child => {
                if (child !== camera) scene.remove(child);
            });
            geometricShapes = [];

            // å‰µå»ºä¸€åœˆå¹¾ä½•å½¢ç‹€
            for (let i = 0; i < 12; i++) {
                const geometry = new THREE.OctahedronGeometry(0.3, 2);
                const material = new THREE.MeshPhongMaterial({
                    color: new THREE.Color().setHSL(i / 12, 1, 0.5),
                    emissive: new THREE.Color().setHSL(i / 12, 1, 0.3)
                });

                const mesh = new THREE.Mesh(geometry, material);
                const angle = (i / 12) * Math.PI * 2;
                mesh.position.x = Math.cos(angle) * 1.5;
                mesh.position.y = Math.sin(angle) * 1.5;
                
                scene.add(mesh);
                geometricShapes.push({
                    mesh,
                    angle,
                    initialRadius: 1.5
                });
            }
        }

        function updateGeometricWave(audioData) {
            const { beat, high, intensity } = audioData;
            const intensityControl = parseFloat(document.getElementById('range-intensity').value) / 100;

            geometricShapes.forEach((shape, idx) => {
                const { mesh } = shape;
                
                // æ³¢ç´‹åŠ¹æœ (è·é›¢è®ŠåŒ–)
                const radius = shape.initialRadius + beat * 0.5 * intensityControl;
                mesh.position.x = Math.cos(shape.angle) * radius;
                mesh.position.y = Math.sin(shape.angle) * radius;

                // æ—‹è½‰
                mesh.rotation.x += high * 0.05;
                mesh.rotation.y += high * 0.05;

                // å°ºå¯¸
                mesh.scale.setScalar(1 + intensity * 0.3);

                // é¡è‰²è®ŠåŒ–
                const hue = (idx / 12 + high + Date.now() / 5000) % 1;
                mesh.material.color.setHSL(hue, 1, 0.5);
            });
        }

        // â•â•â• é è¨­é¢¨æ ¼ï¼šèƒ½é‡ç²’å­ â•â•â•
        function setupParticles() {
            scene.children.forEach(child => {
                if (child !== camera) scene.remove(child);
            });
            
            const particlesCount = 1000;
            const geometry = new THREE.BufferGeometry();
            const positions = new Float32Array(particlesCount * 3);
            const colors = new Float32Array(particlesCount * 3);

            for (let i = 0; i < particlesCount; i++) {
                positions[i * 3] = (Math.random() - 0.5) * 4;
                positions[i * 3 + 1] = (Math.random() - 0.5) * 4;
                positions[i * 3 + 2] = (Math.random() - 0.5) * 4;

                colors[i * 3] = Math.random();
                colors[i * 3 + 1] = Math.random();
                colors[i * 3 + 2] = Math.random();
            }

            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));

            const material = new THREE.PointsMaterial({
                size: 0.02,
                vertexColors: true,
                sizeAttenuation: true
            });

            particleSystem = new THREE.Points(geometry, material);
            scene.add(particleSystem);
        }

        function updateParticles(audioData) {
            const { beat, mid, intensity } = audioData;
            const speedControl = parseFloat(document.getElementById('range-speed').value) / 100;

            if (particleSystem) {
                const positions = particleSystem.geometry.attributes.position.array;
                
                for (let i = 0; i < positions.length; i += 3) {
                    positions[i] += (Math.random() - 0.5) * intensity * 0.1;
                    positions[i + 1] += (Math.random() - 0.5) * beat * 0.1;
                    positions[i + 2] += (Math.random() - 0.5) * mid * 0.1;
                }
                
                particleSystem.geometry.attributes.position.needsUpdate = true;
                particleSystem.rotation.x += speedControl * 0.01;
                particleSystem.rotation.y += speedControl * 0.01;
            }
        }

        // â•â•â• é è¨­é¢¨æ ¼åˆ‡æ› â•â•â•
        document.querySelectorAll('.preset-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.preset-btn').forEach(b => {
                    b.classList.remove('active', 'bg-indigo-600', 'border-indigo-400');
                    b.classList.add('bg-gray-700', 'hover:bg-gray-600', 'border-transparent');
                });
                
                btn.classList.add('active', 'bg-indigo-600', 'border-indigo-400');
                btn.classList.remove('bg-gray-700', 'hover:bg-gray-600', 'border-transparent');

                currentPreset = btn.dataset.preset;
                
                switch(currentPreset) {
                    case 'neon': setupNeonGlitch(); break;
                    case 'liquid': setupLiquidFlow(); break;
                    case 'geometric': setupGeometricWave(); break;
                    case 'particle': setupParticles(); break;
                }
            });
        });

        // â•â•â• å‹•ç•«å¾ªç’° â•â•â•
        function animate() {
            requestAnimationFrame(animate);

            const audioData = getAudioData();

            switch(currentPreset) {
                case 'neon': updateNeonGlitch(audioData); break;
                case 'liquid': updateLiquidFlow(audioData); break;
                case 'geometric': updateGeometricWave(audioData); break;
                case 'particle': updateParticles(audioData); break;
            }

            renderer.render(scene, camera);
        }

        // åˆå§‹åŒ–
        window.onload = function() {
            init();
            setupNeonGlitch();
            animate();
            updateButtonState();
        };
    </script>
</body>
</html>
